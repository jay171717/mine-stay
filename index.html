<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MineStay — Bot Control (Chunk 2)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #0f1720;
    --panel: #0b1220;
    --muted: #94a3b8;
    --accent: #6ee7b7;
    --card: #0f1726;
  }
  body { background: var(--bg); color: #e6eef8; font-family: Inter, Arial; margin: 0; padding: 20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
  h1 { font-size: 20px; margin:0; }
  #main { display:flex; gap: 16px; }
  #left { width: 320px; }
  .card { background: var(--card); border-radius: 8px; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
  #botList .botItem { padding:10px; border-radius:6px; margin-bottom:8px; background:#09111a; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  #botList .botItem.selected { outline: 2px solid var(--accent); }
  .botName { font-weight:700; }
  .small { font-size: 12px; color: var(--muted); }
  #right { flex:1; }
  .tabs { display:flex; gap:8px; margin-bottom:12px; }
  .tab { padding:8px 12px; background:#07101a; cursor:pointer; border-radius:6px; }
  .tab.active { background: linear-gradient(90deg,#04202a,#06343b); }
  .section { background: linear-gradient(180deg,#071829,#04121a); padding: 12px; border-radius:8px; }
  button { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--accent); padding:6px 8px; border-radius:6px; cursor:pointer; }
  input, select { padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:#02131a; color:#dff9ee; }
  .hotbar { display:flex; gap:6px; margin-top:8px; }
  .slot { background:#041218; padding:6px; border-radius:6px; min-width:80px; text-align:center; }
  .debugLog { background:#06121b; padding:8px; border-radius:6px; height:180px; overflow:auto; font-family: monospace; font-size:12px; color:#cfeee0; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
</style>
</head>
<body>
<header>
  <h1>MineStay — Bot Control (Chunk 2)</h1>
  <div>
    <span class="small">Server:</span> <strong>fakesalmon.aternos.me:25565</strong>
  </div>
</header>

<div id="main">
  <div id="left">
    <div class="card">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="addBotInput" placeholder="Bot username" />
        <button id="addBotBtn">Add</button>
      </div>
      <hr style="margin:10px 0; border:none; border-top:1px solid rgba(255,255,255,0.04)" />
      <div id="botList"></div>
    </div>
  </div>

  <div id="right">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div id="selectedName"><strong>Select a bot</strong></div>
          <div id="selectedOnline" class="small">No bot selected</div>
        </div>
        <div>
          <button id="startStopBtn" style="display:none">Stop</button>
          <button id="deleteBtn" style="display:none">Delete</button>
        </div>
      </div>

      <div class="tabs" id="tabs" style="margin-top:12px; display:none">
        <div class="tab active" data-tab="status">Status</div>
        <div class="tab" data-tab="inventory">Inventory</div>
        <div class="tab" data-tab="movement">Movement/Looking</div>
        <div class="tab" data-tab="actions">Actions</div>
        <div class="tab" data-tab="debug">Debug</div>
      </div>

      <div id="tabContent" style="margin-top:12px;">
        <!-- STATUS -->
        <div id="tab-status" class="section">
          <div id="statusBlock">Select a bot to view status.</div>
        </div>

        <!-- INVENTORY -->
        <div id="tab-inventory" class="section" style="display:none">
          <div class="row">
            <div><strong>Hotbar</strong></div>
          </div>
          <div class="hotbar" id="hotbar"></div>
          <div style="margin-top:8px;">
            Offhand: <span id="offhand">N/A</span>
            <button id="swapBtn">Swap</button>
          </div>
        </div>

        <!-- MOVEMENT / LOOKING -->
        <div id="tab-movement" class="section" style="display:none">
          <div class="row">
            <div>
              <strong>Continuous Movement</strong><br/>
              <button onclick="moveCont('forward', true)">W</button>
              <button onclick="moveCont('back', true)">S</button>
              <button onclick="moveCont('left', true)">A</button>
              <button onclick="moveCont('right', true)">D</button>
              <button onclick="stopAllMove()">Stop</button>
            </div>
          </div>

          <div class="row">
            <div>
              <strong>Move X blocks</strong>
              <select id="moveDir">
                <option value="forward">Forward</option>
                <option value="back">Back</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
              </select>
              <input id="moveBlocksInput" placeholder="blocks" style="width:80px" />
              <button onclick="moveBlocks()">Go</button>
            </div>
          </div>

          <hr />

          <div class="row">
            <div>
              <strong>Look (degrees)</strong><br/>
              Deg step: <input id="degStep" value="15" style="width:60px" />
              <div style="margin-top:6px;">
                <button onclick="lookDelta(0,-1)">↑</button>
                <button onclick="lookDelta(-1,0)">←</button>
                <button onclick="lookDelta(1,0)">→</button>
                <button onclick="lookDelta(0,1)">↓</button>
              </div>
            </div>
            <div style="margin-left:16px;">
              <strong>Look at block</strong><br/>
              X <input id="lookX" style="width:70px" /> Y <input id="lookY" style="width:70px" /> Z <input id="lookZ" style="width:70px" />
              <button onclick="lookAtCoords()">Look</button>
            </div>
          </div>

          <hr />

          <div class="row">
            <div>
              <strong>Go To Coordinates (simple)</strong><br/>
              X <input id="gotoX" style="width:70px" /> Y <input id="gotoY" style="width:70px" /> Z <input id="gotoZ" style="width:70px" />
              <button onclick="goToCoords()">Go</button>
            </div>
          </div>
        </div>

        <!-- ACTIONS placeholder -->
        <div id="tab-actions" class="section" style="display:none">
          <div class="row">Actions will be implemented in Chunk 3.</div>
        </div>

        <!-- DEBUG -->
        <div id="tab-debug" class="section" style="display:none">
          <div class="debugLog" id="debugLog"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* Client JS: handles UI, socket updates, and calling REST endpoints */
const socket = io();
let bots = [];
let selected = null;
let currentYaw = 0; // for look delta convenience
let currentPitch = 0;

const botListEl = document.getElementById('botList');
const addBotInput = document.getElementById('addBotInput');
const addBotBtn = document.getElementById('addBotBtn');

addBotBtn.onclick = async () => {
  const name = addBotInput.value.trim();
  if (!name) return alert('Enter bot username');
  await fetch('/api/bots', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:name}) });
  addBotInput.value = '';
};

socket.on('connect', () => {
  console.log('Connected to server socket');
});

socket.on('bots', (list) => {
  bots = list;
  renderBotList();
  if (selected) {
    const still = bots.find(b=>b.username===selected);
    if (!still) {
      selected = null;
      showNoSelection();
    } else {
      renderSelected();
    }
  }
});

socket.on('debug', msg => {
  const el = document.getElementById('debugLog');
  const time = new Date(msg.ts).toLocaleTimeString();
  el.innerHTML += `[${time}] [${msg.username}] ${escapeHtml(msg.text)}\n`;
  el.scrollTop = el.scrollHeight;
});

/* Tabs */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.getAttribute('data-tab');
  document.querySelectorAll('[id^="tab-"]').forEach(x=>x.style.display='none');
  document.getElementById('tab-'+tab).style.display='block';
}));

function renderBotList() {
  botListEl.innerHTML = '';
  bots.forEach(bot=>{
    const el = document.createElement('div');
    el.className='botItem'+(selected===bot.username?' selected':'');
    el.innerHTML = `<span class="botName">${bot.username}</span><span class="small">${bot.online?'online':'offline'}</span>`;
    el.onclick = () => { selected = bot.username; renderBotList(); renderSelected(); };
    botListEl.appendChild(el);
  });
}

function showNoSelection() {
  document.getElementById('selectedName').innerText='Select a bot';
  document.getElementById('selectedOnline').innerText='No bot selected';
  document.getElementById('startStopBtn').style.display='none';
  document.getElementById('deleteBtn').style.display='none';
  document.getElementById('tabs').style.display='none';
}

function renderSelected() {
  if (!selected) return showNoSelection();
  const bot = bots.find(b=>b.username===selected);
  if (!bot) return showNoSelection();
  document.getElementById('selectedName').innerText=bot.username;
  document.getElementById('selectedOnline').innerText=bot.online?'Online':'Offline';
  document.getElementById('startStopBtn').style.display='inline-block';
  document.getElementById('deleteBtn').style.display='inline-block';
  document.getElementById('tabs').style.display='flex';

  // Update hotbar
  const hotbarEl = document.getElementById('hotbar');
  hotbarEl.innerHTML='';
  if (bot.hotbar) {
    bot.hotbar.forEach((i, idx)=>{
      const s = document.createElement('div');
      s.className='slot';
      s.innerText=`${idx}: ${i||'Empty'}`;
      hotbarEl.appendChild(s);
    });
  }
  document.getElementById('offhand').innerText=bot.offhand||'N/A';

  // Status
  document.getElementById('statusBlock').innerText=`Health: ${bot.health||0} Hunger: ${bot.hunger||0}`;
}

/* Movement / Look functions */
function moveCont(dir, on=true){ if(!selected) return; fetch(`/api/move/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({dir,on})}); }
function stopAllMove(){ if(!selected) return; fetch(`/api/move/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify({stop:true})}); }
function moveBlocks(){ if(!selected) return; const dir=document.getElementById('moveDir').value; const steps=parseFloat(document.getElementById('moveBlocksInput').value)||0; fetch(`/api/move/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({dir,blocks:steps})}); }
function lookDelta(dx,dy){ if(!selected) return; const deg=parseFloat(document.getElementById('degStep').value)||15; fetch(`/api/look/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'}, body:JSON.stringify({dx:dx*deg,dy:dy*deg})}); }
function lookAtCoords(){ if(!selected) return; const x=parseFloat(document.getElementById('lookX').value); const y=parseFloat(document.getElementById('lookY').value); const z=parseFloat(document.getElementById('lookZ').value); fetch(`/api/lookat/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({x,y,z})}); }
function goToCoords(){ if(!selected) return; const x=parseFloat(document.getElementById('gotoX').value); const y=parseFloat(document.getElementById('gotoY').value); const z=parseFloat(document.getElementById('gotoZ').value); fetch(`/api/goto/${selected}`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({x,y,z})}); }

/* Delete / Stop buttons */
document.getElementById('deleteBtn').onclick=()=>{ if(!selected) return; fetch(`/api/bots/${selected}`,{method:'DELETE'}); };
document.getElementById('startStopBtn').onclick=()=>{ if(!selected) return; fetch(`/api/toggle/${selected}`,{method:'POST'}); };

/* Debug helper */
function escapeHtml(text){ return text.replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); }); }
</script>
</body>
</html>

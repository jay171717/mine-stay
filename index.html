<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MineStay — Bot Control (Chunk 2)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root {
    --bg: #0f1720;
    --panel: #0b1220;
    --muted: #94a3b8;
    --accent: #6ee7b7;
    --card: #0f1726;
  }
  body { background: var(--bg); color: #e6eef8; font-family: Inter, Arial; margin: 0; padding: 20px; }
  header { display:flex; align-items:center; justify-content:space-between; margin-bottom: 16px; }
  h1 { font-size: 20px; margin:0; }
  #main { display:flex; gap: 16px; }
  #left { width: 320px; }
  .card { background: var(--card); border-radius: 8px; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.6); }
  #botList .botItem { padding:10px; border-radius:6px; margin-bottom:8px; background:#09111a; cursor:pointer; display:flex; justify-content:space-between; align-items:center; }
  #botList .botItem.selected { outline: 2px solid var(--accent); }
  .botName { font-weight:700; }
  .small { font-size: 12px; color: var(--muted); }
  #right { flex:1; }
  .tabs { display:flex; gap:8px; margin-bottom:12px; }
  .tab { padding:8px 12px; background:#07101a; cursor:pointer; border-radius:6px; }
  .tab.active { background: linear-gradient(90deg,#04202a,#06343b); }
  .section { background: linear-gradient(180deg,#071829,#04121a); padding: 12px; border-radius:8px; }
  button { background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--accent); padding:6px 8px; border-radius:6px; cursor:pointer; }
  input, select { padding:6px; border-radius:6px; border:1px solid rgba(255,255,255,0.06); background:#02131a; color:#dff9ee; }
  .hotbar { display:flex; gap:6px; margin-top:8px; }
  .slot { background:#041218; padding:6px; border-radius:6px; min-width:80px; text-align:center; }
  .debugLog { background:#06121b; padding:8px; border-radius:6px; height:180px; overflow:auto; font-family: monospace; font-size:12px; color:#cfeee0; }
  .row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
</style>
</head>
<body>
<header>
  <h1>MineStay — Bot Control (Chunk 2)</h1>
  <div>
    <span class="small">Server:</span> <strong>fakesalmon.aternos.me:25565</strong>
  </div>
</header>

<div id="main">
  <div id="left">
    <div class="card">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="addBotInput" placeholder="Bot username" />
        <button id="addBotBtn">Add</button>
      </div>
      <hr style="margin:10px 0; border:none; border-top:1px solid rgba(255,255,255,0.04)" />
      <div id="botList"></div>
    </div>
  </div>

  <div id="right">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div id="selectedName"><strong>Select a bot</strong></div>
          <div id="selectedOnline" class="small">No bot selected</div>
        </div>
        <div>
          <button id="startStopBtn" style="display:none">Stop</button>
          <button id="deleteBtn" style="display:none">Delete</button>
        </div>
      </div>

      <div class="tabs" id="tabs" style="margin-top:12px; display:none">
        <div class="tab active" data-tab="status">Status</div>
        <div class="tab" data-tab="inventory">Inventory</div>
        <div class="tab" data-tab="movement">Movement/Looking</div>
        <div class="tab" data-tab="actions">Actions</div>
        <div class="tab" data-tab="debug">Debug</div>
      </div>

      <div id="tabContent" style="margin-top:12px;">
        <!-- STATUS -->
        <div id="tab-status" class="section">
          <div id="statusBlock">Select a bot to view status.</div>
        </div>

        <!-- INVENTORY -->
        <div id="tab-inventory" class="section" style="display:none">
          <div class="row">
            <div><strong>Hotbar</strong></div>
          </div>
          <div class="hotbar" id="hotbar"></div>
          <div style="margin-top:8px;">
            Offhand: <span id="offhand">N/A</span>
            <button id="swapBtn">Swap</button>
          </div>
        </div>

        <!-- MOVEMENT / LOOKING -->
        <div id="tab-movement" class="section" style="display:none">
          <div class="row">
            <div>
              <strong>Continuous Movement</strong><br/>
              <button onclick="moveCont('forward', true)">W</button>
              <button onclick="moveCont('back', true)">S</button>
              <button onclick="moveCont('left', true)">A</button>
              <button onclick="moveCont('right', true)">D</button>
              <button onclick="stopAllMove()">Stop</button>
            </div>
          </div>

          <div class="row">
            <div>
              <strong>Move X blocks</strong>
              <select id="moveDir">
                <option value="forward">Forward</option>
                <option value="back">Back</option>
                <option value="left">Left</option>
                <option value="right">Right</option>
              </select>
              <input id="moveBlocksInput" placeholder="blocks" style="width:80px" />
              <button onclick="moveBlocks()">Go</button>
            </div>
          </div>

          <hr />

          <div class="row">
            <div>
              <strong>Look (degrees)</strong><br/>
              Deg step: <input id="degStep" value="15" style="width:60px" />
              <div style="margin-top:6px;">
                <button onclick="lookDelta(0,-1)">↑</button>
                <button onclick="lookDelta(-1,0)">←</button>
                <button onclick="lookDelta(1,0)">→</button>
                <button onclick="lookDelta(0,1)">↓</button>
              </div>
            </div>
            <div style="margin-left:16px;">
              <strong>Look at block</strong><br/>
              X <input id="lookX" style="width:70px" /> Y <input id="lookY" style="width:70px" /> Z <input id="lookZ" style="width:70px" />
              <button onclick="lookAtCoords()">Look</button>
            </div>
          </div>

          <hr />

          <div class="row">
            <div>
              <strong>Go To Coordinates (simple)</strong><br/>
              X <input id="gotoX" style="width:70px" /> Y <input id="gotoY" style="width:70px" /> Z <input id="gotoZ" style="width:70px" />
              <button onclick="goToCoords()">Go</button>
            </div>
          </div>
        </div>

        <!-- ACTIONS placeholder -->
        <div id="tab-actions" class="section" style="display:none">
          <div class="row">Actions will be implemented in Chunk 3.</div>
        </div>

        <!-- DEBUG -->
        <div id="tab-debug" class="section" style="display:none">
          <div class="debugLog" id="debugLog"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
/* Client JS: handles UI, socket updates, and calling REST endpoints */
const socket = io();
let bots = [];
let selected = null;
let currentYaw = 0; // for look delta convenience
let currentPitch = 0;

const botListEl = document.getElementById('botList');
const addBotInput = document.getElementById('addBotInput');
const addBotBtn = document.getElementById('addBotBtn');

addBotBtn.onclick = async () => {
  const name = addBotInput.value.trim();
  if (!name) return alert('Enter bot username');
  await fetch('/api/bots', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({username:name}) });
  addBotInput.value = '';
};

socket.on('connect', () => {
  console.log('Connected to server socket');
});

socket.on('bots', (list) => {
  bots = list;
  renderBotList();
  if (selected) {
    const still = bots.find(b=>b.username===selected);
    if (!still) {
      selected = null;
      showNoSelection();
    } else {
      renderSelected();
    }
  }
});

socket.on('debug', msg => {
  const el = document.getElementById('debugLog');
  const time = new Date(msg.ts).toLocaleTimeString();
  el.innerHTML += `[${time}] [${msg.username}] ${escapeHtml(msg.text)}\n`;
  el.scrollTop = el.scrollHeight;
});

/* Tabs */
const tabs = document.querySelectorAll('.tab');
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x=>x.classList.remove('active'));
  t.classList.add('active');
  const tab = t.getAttribute('data-tab');
  document.querySelectorAll('[id^="tab-"]').forEach(s => s.style.display = 'none');
  document.getElementById('tab-' + tab).style.display = 'block';
}));

/* Bot list rendering */
function renderBotList() {
  botListEl.innerHTML = '';
  bots.forEach(b => {
    const div = document.createElement('div');
    div.className = 'botItem';
    if (selected === b.username) div.classList.add('selected');
    div.onclick = () => { selected = b.username; renderSelected(); renderBotList(); };
    div.innerHTML = `<div>
      <div class="botName">${b.username}</div>
      <div class="small">${b.status} ${b.enabled ? '' : '(disabled)'}</div>
    </div>
    <div>
      <button onclick="toggleBot(event,'${b.username}')">${b.enabled ? 'Stop' : 'Start'}</button>
      <button onclick="deleteBot(event,'${b.username}')">Delete</button>
    </div>`;
    botListEl.appendChild(div);
  });

  // show/hide tabs panel
  document.getElementById('tabs').style.display = bots.length ? 'flex' : 'none';
}

/* Selection / Details */
function showNoSelection() {
  document.getElementById('selectedName').innerHTML = '<strong>Select a bot</strong>';
  document.getElementById('selectedOnline').innerText = 'No bot selected';
  document.getElementById('startStopBtn').style.display = 'none';
  document.getElementById('deleteBtn').style.display = 'none';
  document.getElementById('tabs').style.display = 'none';
  document.getElementById('tab-status').style.display = 'block';
  document.getElementById('tab-inventory').style.display = 'none';
  document.getElementById('tab-movement').style.display = 'none';
  document.getElementById('tab-actions').style.display = 'none';
  document.getElementById('tab-debug').style.display = 'none';
  document.getElementById('statusBlock').innerText = 'Select a bot to view status.';
}

function renderSelected() {
  if (!selected) return showNoSelection();
  const bot = bots.find(b=>b.username===selected);
  if (!bot) return showNoSelection();

  document.getElementById('selectedName').innerHTML = `<strong>${bot.username}</strong>`;
  document.getElementById('selectedOnline').innerText = bot.status + (bot.enabled ? '' : ' (disabled)');
  document.getElementById('startStopBtn').style.display = 'inline-block';
  document.getElementById('startStopBtn').innerText = bot.enabled ? 'Stop' : 'Start';
  document.getElementById('deleteBtn').style.display = 'inline-block';
  document.getElementById('tabs').style.display = 'flex';

  // Status tab
  const pos = bot.position ? `x:${bot.position.x.toFixed(2)}, y:${bot.position.y.toFixed(2)}, z:${bot.position.z.toFixed(2)}` : 'N/A';
  document.getElementById('statusBlock').innerHTML = `
    <div class="row"><strong>Status:</strong> ${bot.status} ${bot.enabled ? '' : '(disabled)'}</div>
    <div class="row"><strong>Position:</strong> ${pos}</div>
    <div class="row"><strong>Health:</strong> ${bot.health} <strong>Hunger:</strong> ${bot.food} <strong>XP:</strong> ${bot.xp}</div>
    <div class="row"><strong>Uptime:</strong> ${bot.uptime}s</div>
  `;

  // Inventory tab: we need to request the server for latest inventory (server emits update that contains hotbar info)
  // The server sends full bots object with status, but not detailed hotbar items yet — the backend emits regular updates including inventory in Chunk 3.
  // For now show placeholder; when server sends inventory, it will be included in bots list.
  renderInventory(bot);
}

/* API calls */
async function toggleBot(event, username) {
  event.stopPropagation();
  await fetch(`/api/bots/${username}/toggle`, { method:'POST', headers:{'Content-Type':'application/json'} });
}

async function deleteBot(event, username) {
  event.stopPropagation();
  if (!confirm('Delete bot permanently?')) return;
  await fetch(`/api/bots/${username}`, { method:'DELETE' });
  if (selected === username) { selected = null; showNoSelection(); }
}

/* Inventory rendering & actions */
function renderInventory(bot) {
  const hotbarEl = document.getElementById('hotbar');
  hotbarEl.innerHTML = '';
  // hotbar data expected to be in bot.hotbar (an array of 9 slots), offhand in bot.offhand
  const hotbar = bot.hotbar || Array.from({length:9}).map((_,i)=>({ name:'Empty', count:0 }));
  hotbar.forEach((slot, i) => {
    const s = document.createElement('div');
    s.className = 'slot';
    s.innerHTML = `<div>${slot.name || 'Empty'}</div><div class="small">${slot.count||0}</div><div style="margin-top:6px"><button onclick="selectSlot(event,'${bot.username}', ${i})">Select</button></div>`;
    hotbarEl.appendChild(s);
  });
  document.getElementById('offhand').innerText = (bot.offhand && bot.offhand.name) ? `${bot.offhand.name} (${bot.offhand.count||0})` : 'Empty';
  document.getElementById('swapBtn').onclick = () => swapOffhand(bot.username);
}

/* Inventory actions */
async function selectSlot(e, username, slot) {
  e.stopPropagation();
  await fetch(`/api/bots/${username}/selectSlot`, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ slot })
  });
}

async function swapOffhand(username) {
  await fetch(`/api/bots/${username}/swap`, { method:'POST' });
}

/* Movement / Looking functions */
async function moveCont(direction, enable) {
  if (!selected) return alert('Select bot first');
  await fetch(`/api/bots/${selected}/move`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ direction, enable })
  });
}

async function stopAllMove() {
  if (!selected) return;
  ['forward','back','left','right'].forEach(d => moveCont(d, false));
}

async function moveBlocks() {
  if (!selected) return alert('Select bot first');
  const dir = document.getElementById('moveDir').value;
  const blocks = Number(document.getElementById('moveBlocksInput').value || 1);
  await fetch(`/api/bots/${selected}/moveBlocks`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ direction: dir, blocks })
  });
}

async function lookDelta(dx, dy) {
  if (!selected) return alert('Select bot first');
  const step = Number(document.getElementById('degStep').value || 15);
  currentYaw += dx * step;
  currentPitch += dy * step;
  await fetch(`/api/bots/${selected}/look`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ yaw: currentYaw, pitch: currentPitch })
  });
}

async function lookAtCoords() {
  if (!selected) return alert('Select bot first');
  const x = Number(document.getElementById('lookX').value);
  const y = Number(document.getElementById('lookY').value);
  const z = Number(document.getElementById('lookZ').value);
  await fetch(`/api/bots/${selected}/lookAt`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ x, y, z })
  });
}

async function goToCoords() {
  if (!selected) return alert('Select bot first');
  const x = Number(document.getElementById('gotoX').value);
  const y = Number(document.getElementById('gotoY').value);
  const z = Number(document.getElementById('gotoZ').value);
  await fetch(`/api/bots/${selected}/goTo`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ x, y, z })
  });
}

/* Utility */
function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* update UI periodically */
setInterval(() => {
  if (selected) renderSelected();
}, 1000);
</script>
</body>
</html>
